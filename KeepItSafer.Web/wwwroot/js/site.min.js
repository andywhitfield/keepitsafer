function initialiseCommon(){localSettings=simpleStorage.get("keepitsafer");localSettings==undefined&&(localSettings={expanded:[]})}function saveLocalSettings(){var n=[],t=$("#PasswordGroups"),i=$(".group-section article:visible",t).each(function(){n.push($(this).parents("section").attr("data-id"))});localSettings.expanded=n;console.log("saving expanded groups: "+n);simpleStorage.set("keepitsafer",localSettings)}function initialiseCreateMasterPassword(){initialiseCommon();$("#newmasterpassword").focus()}function initialisePasswordGroups(){var n,t;initialiseCommon();n=$("#PasswordGroups");$("section",n).children("article").hide();$(".group-section div",n).click(toggleShowHideGroupItems);$('.password-list input[type="text"]').mousedown(decryptPassword);$(".password-list li").mousedown(hideDecryptedPassword);$('.password-list input[type="button"]').click(deleteEntry);$("#modal-background, #modal-close, #modal-content input[value='Cancel']").click(function(){closeModalDialog()});$(document).keydown(function(n){n.keyCode===27&&closeModalDialog()});$("#masterpasswordentryform").submit(handleMasterPasswordEntered);$("#addnewentryvalueencrypted").change(function(){$("#addnewentryvalue").attr("type",$(this).is(":checked")?"password":"text")});$("#addnewentryform").submit(handleAddNewEntry);$('#addnewentryform input[type="text"]').keyup(setAddNewEntryEnabledState);$('#addnewentryform input[type="text"]').change(setAddNewEntryEnabledState);setAddNewEntryEnabledState();$("#passwordgeneratorform").submit(handleGeneratePassword);t=localSettings.expanded;console.log("restoring expanded groups: "+t);$.each(t,function(t,i){$(".group-section[data-id='"+i+"'] article",n).show()})}function closeModalDialog(){console.log("hiding any current modal dialog");$("#modal-content, #modal-background").removeClass("active")}function showModalDialog(n,t){closeModalDialog();var i=$("#modal-content .modal-content-header");(n||"")==""?i.hide():(i.text(n),i.attr("data-level",t||"info"),i.show());console.log("showing dialog with message "+t+"["+n+"]");$("#modal-content, #modal-background").addClass("active")}function toggleShowHideGroupItems(){var n=$(this);console.log("group clicked: "+n.parent().attr("data-id"));n.next().toggle();$(window).scrollTop(n.position().top);saveLocalSettings()}function hideDecryptedPassword(){var n=$('input[type="text"]',$(this));if(n.attr("data-type")=="encrypted"&&n.attr("data-decrypted")=="true"){console.log("password decrypted, reverting back to ****.");n.val("****");n.attr("data-decrypted","false");return}}function handleMasterPasswordEntered(n){var t=$("#masterpasswordentryform"),e=$("input[name=action]",t).val(),i=$("input[name=group]",t).val(),r=$("input[name=entry]",t).val(),o=$("input[name=value]",t).val(),s=$("input[name=valueEncrypted]",t).val(),h=$("input[name=masterpassword]",t),u=$("input:checked[name=remembermasterpassword]",t).val(),f=h.val();return h.val(""),console.log("re-submit request with form details: group="+i+";entry="+r+";value="+o+";valueEncrypted="+s+";masterpw="+f+";rememberMasterPassword="+u),e=="decrypt"?decrypt(i,r,f,u):e=="delete"?callDeleteEntry(i,r,f,u):e=="add"&&addNewEntry(i,r,s,o,f,u),closeModalDialog(),n.preventDefault(),!1}function decryptPassword(n){var t;if(n.stopPropagation(),!$(this).is(":focus")){if(t=$(this),t.attr("data-type")!="encrypted"||t.attr("data-decrypted")=="true"){console.log("password not encrypted or already decrypted, nothing to do.");setTimeout(function(){t[0].setSelectionRange(0,9999)},10);return}var i=t.parents("li"),r=i.attr("data-id"),u=i.parents("section").attr("data-id");console.log("password clicked: "+r+" in group "+u);decrypt(u,r)}}function decrypt(n,t,i,r){$.post("/api/decrypt",{group:n,entry:t,masterPassword:i||"",rememberMasterPassword:r||"false"}).done(function(i){var f,r,u,e;if(console.log("received decrypt: "+i.decrypted+":"+i.decryptedValue+":"+i.reason+":group="+n+":entry="+t),i.decrypted){n=n.replace(new RegExp("'","g"),"\\'");t=t.replace(new RegExp("'","g"),"\\'");f=$("section[data-id='"+n+"'] li[data-id='"+t+"'] :text");f.val(i.decryptedValue);f.attr("data-decrypted","true");f[0].setSelectionRange(0,9999);return}r=$("#masterpasswordentryform");$("input[name=action]",r).val("decrypt");$("input[name=group]",r).val(n);$("input[name=entry]",r).val(t);$(":password",r).val("");u="";e="info";i.reason==0?u="Please enter your master password.":i.reason==1?(u="Incorrect master password, please try again.",e="warn"):(u="Unknown error decrypting. Try entering your master password again.",e="error");showModalDialog(u,e);$(":password",r).focus()}).fail(function(){console.log("decrypt api call failed")})}function deleteEntry(){var r=$(this),t=r.parents("li"),n=t.attr("data-id"),i=t.parents("section").attr("data-id");(console.log("delete button clicked: "+n+" in group "+i),confirm('Are you sure you want to delete "'+n+'"?'))&&callDeleteEntry(i,n)}function callDeleteEntry(n,t,i,r){$.post("/api/delete",{group:n,entry:t,masterPassword:i||"",rememberMasterPassword:r||"false"}).done(function(i){var r,u,f;if(console.log("received delete result: "+i.deleted+":"+i.reason),i.deleted){location.reload(!0);return}r=$("#masterpasswordentryform");$("input[name=action]",r).val("delete");$("input[name=group]",r).val(n);$("input[name=entry]",r).val(t);$(":password",r).val("");u="";f="info";i.reason==0?u="Please enter your master password.":i.reason==1?(u="Incorrect master password, please try again.",f="warn"):(u="Unknown error deleting this entry. Try entering your master password again.",f="error");showModalDialog(u,f);$(":password",r).focus()}).fail(function(){console.log("delete api call failed")})}function allowAddNewEntry(){var n=!0;return $('#addnewentryform input[type="text"], #addnewentryform input[type="password"]').each(function(){n=n&&$(this).val()!=""}),n}function setAddNewEntryEnabledState(){allowAddNewEntry()?$("#addnewentryform :submit").removeAttr("disabled"):$("#addnewentryform :submit").attr("disabled","disabled")}function handleAddNewEntry(n){if(allowAddNewEntry()){var t=$("#addnewentryform"),i=$("input[name=addnewentrygroup]",t).val(),r=$("input[name=addnewentryname]",t).val(),u=$("input:checked[name=addnewentryvalueencrypted]",t).val()||"false",f=$("input[name=addnewentryvalue]",t).val();console.log("submit add request with form details: group="+i+";entry="+r+";valueEncrypted="+u+";value="+f);addNewEntry(i,r,u,f)}return n.preventDefault(),!1}function addNewEntry(n,t,i,r,u,f){$.post("/api/add",{group:n,entry:t,valueEncrypted:i,value:r,masterPassword:u||"",rememberMasterPassword:f||"false"}).done(function(u){var f,e,o;if(console.log("received add result: "+u.added+":"+u.reason),u.added){location.reload(!0);return}f=$("#masterpasswordentryform");$("input[name=action]",f).val("add");$("input[name=group]",f).val(n);$("input[name=entry]",f).val(t);$("input[name=value]",f).val(r);$("input[name=valueEncrypted]",f).val(i);$(":password",f).val("");e="";o="info";u.reason==0?e="Please enter your master password.":u.reason==1?(e="Incorrect master password, please try again.",o="warn"):(e="Unknown error adding this entry. Try entering your master password again.",o="error");showModalDialog(e,o);$(":password",f).focus()}).fail(function(){console.log("add api call failed")})}function handleGeneratePassword(n){var t=$("#passwordgeneratorform"),i=$("input[name=genpassminpasswordlength]",t).val(),r=$("input[name=genpassmaxpasswordlength]",t).val(),u=$("input:checked[name=genpassspecialchars]",t).val()||"false",f=$("input:checked[name=genpassnumbers]",t).val()||"false";return console.log("generate passwords given min="+i+";max="+r+";special="+u+";numbers="+f),$.post("/api/genpasswords",{minLength:i,maxLength:r,allowSpecialCharacters:u,allowNumbers:f}).done(function(n){console.log("received generate passwords result: "+n.passwords);var t=$("#genpassoutput");if(t.empty(),n.passwords.length==0){t.text("Word dictionary loading...please try again in a few moments.");return}$.each(n.passwords,function(n,i){var r=$("<input />").attr("type","text").val(i);t.append(r).append("<br />")});$("input",t).mousedown(function(n){if(n.stopPropagation(),!$(this).is(":focus")){var t=$(this)[0];window.setTimeout(function(){t.setSelectionRange(0,9999)},10)}})}).fail(function(){console.log("generate password api call failed")}),n.preventDefault(),!1}var localSettings;